<div id="gate" style="position: fixed; inset: 0; z-index: 10000; background: #fdfbf7; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-family: sans-serif;">
    <h1 style="font-size: 5rem; font-weight: 900; color: #eab308; font-style: italic; margin: 0; letter-spacing: -0.05em; text-shadow: 2px 2px 0px #fef3c7;">SIUUUU!</h1>
    <p style="color: #94a3b8; margin-bottom: 40px; font-size: 10px; font-weight: bold; letter-spacing: 0.5em;">SQUAD ONLY ARCHIVE</p>
    <div style="width: 100%; max-width: 300px; padding: 0 20px;">
        <input id="userName" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
               style="width: 100%; padding: 20px; border-radius: 20px; background: white; color: #334155; border: 2px solid #f1f5f9; text-align: center; outline: none; margin-bottom: 15px; font-size: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <button onclick="handleLogin()" style="width: 100%; background: #eab308; color: white; padding: 20px; border-radius: 20px; font-weight: 900; font-size: 18px; border: none; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 15px -3px rgba(234, 179, 8, 0.3);">ì…ì¥í•˜ê¸°</button>
    </div>
</div>

<div id="app" style="display: none; min-height: 100vh; max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 100px; font-family: sans-serif;">
    <header style="padding: 25px 5px; display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 2.2rem; font-weight: 900; color: #eab308; font-style: italic; margin: 0;">SIUUUU! ğŸ”¥</h1>
        <button onclick="handleLogout()" style="font-size: 10px; font-weight: bold; opacity: 0.5; border: 1px solid currentColor; padding: 5px 10px; border-radius: 8px; background: none; color: inherit; cursor: pointer;">LOGOUT</button>
    </header>

    <section class="card-ui" style="padding: 20px; border-radius: 32px; margin-bottom: 35px; border: 1px solid var(--border); background: var(--card); transition: all 0.5s; box-shadow: var(--shadow);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="calMonth" style="font-weight: 900; font-size: 1.5rem; margin: 0; color: var(--text);"></h2>
            <div style="display: flex; gap: 15px;">
                <button onclick="moveMonth(-1)" style="color: #eab308; font-weight: bold; border: none; background: none; cursor: pointer; font-size: 1.2rem;">â—€</button>
                <button onclick="moveMonth(1)" style="color: #eab308; font-weight: bold; border: none; background: none; cursor: pointer; font-size: 1.2rem;">â–¶</button>
            </div>
        </div>
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
            <thead>
                <tr style="opacity: 0.5; font-size: 10px; text-transform: uppercase; color: var(--text);">
                    <th style="color:#f87171; padding-bottom: 10px;">Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th style="color:#7dd3fc">Sat</th>
                </tr>
            </thead>
            <tbody id="calBody"></tbody>
        </table>

        <div id="dateEditor" style="display:none; margin-top: 20px; padding: 15px; background: var(--sub-bg); border-radius: 20px; border: 1px solid var(--border);">
            <p id="selectedDateText" style="font-size: 12px; font-weight: 900; color: #eab308; margin-bottom: 10px;"></p>
            <div style="display: flex; gap: 8px;">
                <input id="dateInput" type="text" placeholder="ë‚´ìš©ì„ ì ì–´ì¤˜" style="flex:1; background: white; border: 1px solid #f1f5f9; padding: 12px; border-radius: 12px; font-size: 12px; outline: none; color: #334155;">
                <select id="dateType" style="background: white; border: 1px solid #f1f5f9; border-radius: 12px; padding:0 8px; font-size:11px; color: #334155;">
                    <option value="#ì¼ì •">ğŸ“… ì¼ì •</option>
                    <option value="#ë””ë°ì´">ğŸš© ë””ë°ì´</option>
                </select>
                <button onclick="saveDateEvent()" style="background: #7dd3fc; color:white; border:none; padding:0 15px; border-radius:12px; font-weight:bold; cursor: pointer;">ë“±ë¡</button>
            </div>
        </div>
    </section>

    <div style="width: 100%; overflow: hidden; margin-bottom: 35px; cursor: grab;" id="dragWrapper">
        <div id="scrollContainer" class="scroll-box">
            <button onclick="loadWithMode('all', this)" class="tag-btn active">#ì „ì²´</button>
            <button onclick="loadWithMode('ì¶”ì–µ', this)" class="tag-btn">#ì¶”ì–µ ğŸ§¸</button>
            <button onclick="loadWithMode('ìƒì¼', this)" class="tag-btn">#ìƒì¼ ğŸ‚</button>
            <button onclick="loadWithMode('#ë””ë°ì´', this)" class="tag-btn">#ë””ë°ì´ ğŸš©</button>
            <button onclick="loadWithMode('#ì¼ì •', this)" class="tag-btn">#ì¼ì • ğŸ“…</button>
            <button onclick="loadWithMode('íƒœì§€ì•„', this)" class="tag-btn">#íƒœì§€ì•„</button>
            <button onclick="loadWithMode('ì¡°ì„±ìš°', this)" class="tag-btn">#ì¡°ì„±ìš°</button>
            <button onclick="loadWithMode('ì—¼íƒœì„±', this)" class="tag-btn">#ì—¼íƒœì„±</button>
            <button onclick="loadWithMode('ê¹€íƒœí˜„', this)" class="tag-btn">#ê¹€íƒœí˜„</button>
            <button onclick="loadWithMode('ì´ì¤€ì„œ', this)" class="tag-btn">#ì´ì¤€ì„œ</button>
            <button onclick="loadWithMode('ì´ì§€í˜¸', this)" class="tag-btn">#ì´ì§€í˜¸</button>
            <button onclick="loadWithMode('ì´ë‹¤ì›', this)" class="tag-btn">#ì´ë‹¤ì›</button>
        </div>
    </div>

    <section class="card-ui" style="padding: 25px; margin-bottom: 40px; background: var(--card); border-radius: 32px; border: 1px solid var(--border); box-shadow: var(--shadow);">
        <textarea id="pContent" placeholder="ë©¤ë²„ë“¤ê³¼ ê³µìœ í•˜ê³  ì‹¶ì€ ìˆœê°„ì€?" style="width: 100%; background: var(--sub-bg); border-radius: 20px; padding: 15px; border: none; outline: none; margin-bottom: 15px; height: 90px; resize: none; color: var(--text); font-size: 14px;"></textarea>
        <div style="display: flex; gap: 10px;">
            <input type="file" id="pFile" style="display: none;" onchange="document.getElementById('fLab').innerText='ğŸ“¸ ì‚¬ì§„ ì™„ë£Œ'">
            <label for="pFile" id="fLab" style="flex: 1; background: var(--sub-bg); text-align: center; padding: 16px; border-radius: 18px; font-size: 11px; font-weight: bold; cursor: pointer; border: 1px dashed var(--border); color: #94a3b8;">ì‚¬ì§„ ì¶”ê°€</label>
            <button onclick="savePost()" id="sBtn" style="flex: 1; background: #eab308; color: white; font-weight: 900; padding: 16px; border-radius: 18px; border: none; cursor: pointer;">ê¸°ì–µ ì €ì¥</button>
        </div>
    </section>

    <div id="feed" style="display: flex; flex-direction: column; gap: 30px;"></div>
</div>

<style>
    :root { 
        --card: #ffffff; 
        --border: #f5f0e9; 
        --text: #57534e; 
        --sub-bg: #fffbf7;
        --shadow: 0 10px 30px rgba(183, 163, 143, 0.1);
    }
    
    body { background-color: #fdfbf7; color: var(--text); margin: 0; font-family: sans-serif; -webkit-font-smoothing: antialiased; overflow-x: hidden; }

    /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°•ìŠ¤ ìµœì í™” */
    .scroll-box {
        display: flex;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        gap: 12px;
        padding: 10px 20px;
        /* ìŠ¤í¬ë¡¤ë°”ê°€ ìˆìŒì„ ì‚´ì§ ë³´ì—¬ì¤Œ (PCìš©) */
        scrollbar-width: thin;
        scrollbar-color: #eab308 transparent;
    }

    /* PCì—ì„œ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
    .scroll-box::-webkit-scrollbar { height: 4px; }
    .scroll-box::-webkit-scrollbar-track { background: transparent; }
    .scroll-box::-webkit-scrollbar-thumb { background: #eab308; border-radius: 10px; opacity: 0.3; }

    .tag-btn { 
        flex: 0 0 auto; 
        padding: 12px 20px; 
        border-radius: 100px; 
        border: 1px solid #f1f5f9 !important; 
        background: white; 
        color: #78716c; 
        font-size: 13px; 
        font-weight: 700; 
        cursor: pointer; 
        user-select: none; /* ë“œë˜ê·¸ ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
    }
    .tag-btn.active { background: #eab308 !important; border-color: #eab308 !important; color: white !important; }

    .cal-day { height: 80px; vertical-align: top; padding: 6px; border: 0.5px solid #fdfbf7; cursor: pointer; }
    .cal-num { font-weight: 800; font-size: 13px; color: #d6d3d1; display: block; margin-bottom: 4px; }
    .day-label { font-size: 8px; padding: 3px 6px; border-radius: 6px; display: block; margin-top: 3px; color: white; font-weight: bold; overflow: hidden; white-space: nowrap; text-align: center; }

    body.light-theme { --card: rgba(255, 255, 255, 0.95); --border: rgba(234, 179, 8, 0.1); --text: #44403c; --sub-bg: rgba(255,255,255,0.6); }
</style>

<script>
    // [ê°€ë¡œ ë“œë˜ê·¸ ê¸°ëŠ¥ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€]
    const scrollContainer = document.getElementById('scrollContainer');
    let isDown = false;
    let startX;
    let scrollLeft;

    scrollContainer.addEventListener('mousedown', (e) => {
        isDown = true;
        scrollContainer.classList.add('active');
        startX = e.pageX - scrollContainer.offsetLeft;
        scrollLeft = scrollContainer.scrollLeft;
        document.getElementById('dragWrapper').style.cursor = 'grabbing';
    });
    scrollContainer.addEventListener('mouseleave', () => {
        isDown = false;
        document.getElementById('dragWrapper').style.cursor = 'grab';
    });
    scrollContainer.addEventListener('mouseup', () => {
        isDown = false;
        document.getElementById('dragWrapper').style.cursor = 'grab';
    });
    scrollContainer.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - scrollContainer.offsetLeft;
        const walk = (x - startX) * 2; // ìŠ¤í¬ë¡¤ ì†ë„ ì¡°ì ˆ
        scrollContainer.scrollLeft = scrollLeft - walk;
    });

    // [ê¸°ì¡´ supabase ë¡œì§]
    const SQUAD = ['íƒœì§€ì•„', 'ì¡°ì„±ìš°', 'ì—¼íƒœì„±', 'ê¹€íƒœí˜„', 'ì´ì¤€ì„œ', 'ì´ì§€í˜¸', 'ì´ë‹¤ì›'];
    const SB_URL = 'https://chlqufwjiwfiqzvmocof.supabase.co';
    const SB_KEY = 'sb_publishable_MyGDUC1VPEyrWP6THcgWEA_mk8HUpQj'; 
    let client;
    let viewDate = new Date();
    let selDate = "";

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof supabase !== 'undefined') {
            client = supabase.createClient(SB_URL, SB_KEY);
            if (localStorage.getItem('siu_user')) showApp();
        }
    });

    function handleLogin() {
        const n = document.getElementById('userName').value.trim();
        if (SQUAD.includes(n)) { localStorage.setItem('siu_user', n); showApp(); }
    }

    function showApp() {
        document.getElementById('gate').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        renderCalendar();
        loadWithMode('all');
    }

    function handleLogout() { localStorage.removeItem('siu_user'); location.reload(); }

    async function renderCalendar() {
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('calMonth').innerText = `${y}.${String(m+1).padStart(2,'0')}`;
        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m + 1, 0).getDate();
        const body = document.getElementById('calBody'); body.innerHTML = '';
        
        let date = 1;
        for (let i = 0; i < 6; i++) {
            let row = document.createElement('tr');
            for (let j = 0; j < 7; j++) {
                let cell = document.createElement('td');
                cell.className = "cal-day";
                if (i === 0 && j < first || date > last) {
                    cell.innerHTML = "";
                } else {
                    const dKey = `${y}-${String(m+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
                    cell.setAttribute('data-date', dKey);
                    cell.innerHTML = `<span class="cal-num">${date}</span><div class="ev-h"></div>`;
                    cell.onclick = () => { 
                        selDate = dKey; 
                        document.getElementById('dateEditor').style.display='block'; 
                        document.getElementById('selectedDateText').innerText=`ğŸ“ ${dKey} ê¸°ë¡`;
                    };
                    date++;
                }
                row.appendChild(cell);
            }
            body.appendChild(row); if (date > last) break;
        }
        fetchCalData(y, m);
    }

    async function fetchCalData(y, m) {
        const { data } = await client.from('posts').select('*').or('tags.ilike.%#ì¼ì •%,tags.ilike.%#ë””ë°ì´%,tags.ilike.%#ìƒì¼%');
        data?.forEach(ev => {
            const k = ev.created_at?.split('T')[0] || ev.content;
            const holder = document.querySelector(`.cal-day[data-date="${k}"] .ev-h`);
            if(holder) {
                let c = "#7dd3fc"; let t = ev.content;
                if(ev.tags.includes("#ë””ë°ì´")) { 
                    c = "#38bdf8"; 
                    const diff = Math.ceil((new Date(k) - new Date())/(1000*60*60*24));
                    t = `D${diff>=0?'-':'+'}${Math.abs(diff)} ${ev.content}`;
                }
                else if(ev.tags.includes("#ìƒì¼")) { c = "#fbbf24"; t = `ğŸ‚ ${ev.user_name}`; }
                holder.innerHTML += `<span class="day-label" style="background:${c}">${t}</span>`;
            }
        });
    }

    function moveMonth(v) { viewDate.setMonth(viewDate.getMonth() + v); renderCalendar(); }

    async function saveDateEvent() {
        const title = document.getElementById('dateInput').value;
        if(!title) return;
        await client.from('posts').insert([{ user_name: localStorage.getItem('siu_user'), content: title, tags: document.getElementById('dateType').value, created_at: selDate }]);
        location.reload();
    }

    async function loadWithMode(tag, btn) {
        if(btn) {
            document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.body.className = "light-theme"; 
            if(tag === 'ì¶”ì–µ') document.body.style.backgroundColor = "#faf7ed"; 
            else if(tag === 'ìƒì¼') document.body.style.backgroundColor = "#fff1f2"; 
            else if(tag === '#ë””ë°ì´' || tag === '#ì¼ì •') document.body.style.backgroundColor = "#f0f9ff"; 
            else if(SQUAD.includes(tag)) document.body.style.backgroundColor = "#f0fdf4"; 
            else { document.body.style.backgroundColor = "#fdfbf7"; document.body.className = ""; }
        }
        const { data } = await client.from('posts').select('*').not('tags', 'ilike', '%#ìƒì¼ì„¤ì •%').order('created_at', { ascending: false });
        let filtered = (tag === 'all') ? data : data.filter(p => p.tags && p.tags.includes(tag));
        renderFeed(filtered);
    }

    function renderFeed(data) {
        const f = document.getElementById('feed');
        f.innerHTML = data.map(p => `
            <div style="background:var(--card); border: 1px solid var(--border); border-radius:30px; overflow:hidden; color:inherit; box-shadow: var(--shadow); margin-bottom:10px;">
                ${p.image_url ? `<img src="${p.image_url}" style="width:100%; max-height:450px; object-fit:cover;">` : ''}
                <div style="padding:25px;">
                    <p style="margin-bottom:15px; font-size:15.5px; line-height:1.7;">${p.content}</p>
                    <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:700; opacity:0.6; border-top:1px solid var(--border); padding-top:15px;">
                        <span style="color:#eab308;">BY ${p.user_name}</span>
                        <span>${new Date(p.created_at).toLocaleDateString()}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function savePost() {
        const c = document.getElementById('pContent').value; if(!c) return;
        const b = document.getElementById('sBtn'); b.innerText = "ì €ì¥ ì¤‘...";
        let url = ""; const f = document.getElementById('pFile').files[0];
        if(f) {
            const n = `${Date.now()}_${f.name}`;
            await client.storage.from('photos').upload(n, f);
            url = client.storage.from('photos').getPublicUrl(n).data.publicUrl;
        }
        await client.from('posts').insert([{ content: c, image_url: url, user_name: localStorage.getItem('siu_user'), tags: 'ì¼ë°˜' }]);
        location.reload();
    }
</script>