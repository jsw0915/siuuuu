<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>SIUUUU! Infinity Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root {
            --bg-gradient: linear-gradient(135deg, #fdf2f8 0%, #ede9fe 50%, #e0f2fe 100%);
            --main-gradient: linear-gradient(90deg, #ff4d6d 0%, #9b5de5 100%);
            --luck-gradient: linear-gradient(90deg, #10b981 0%, #20c997 100%);
        }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg-gradient); color: #374151; -webkit-tap-highlight-color: transparent; min-height: 100vh; overflow-x: hidden; }

        /* UI êµ¬ì„±ìš”ì†Œ */
        .header { position: sticky; top: 0; z-index: 1000; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .category-bar { display: flex; gap: 10px; overflow-x: auto; padding: 15px 20px; scrollbar-width: none; }
        .category-bar::-webkit-scrollbar { display: none; }
        .tag-btn { flex: 0 0 auto; padding: 10px 22px; border-radius: 50px; background: white; border: 1.5px solid #eee; font-weight: 800; font-size: 13px; cursor: pointer; transition: 0.3s; color: #78716c; }
        .tag-btn.active { color: white !important; transform: scale(1.05); box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-color: transparent !important; }

        .box { max-width: 550px; margin: 20px auto; background: white; border-radius: 35px; padding: 25px; box-shadow: 0 15px 50px rgba(0,0,0,0.05); }
        textarea { width: 100%; border-radius: 20px; border: 1px solid #f1f5f9; background: #f8fafc; padding: 18px; font-family: inherit; margin-bottom: 12px; outline: none; resize: none; box-sizing: border-box; }
        
        /* ì¹´ë“œ ë””ìì¸ */
        .card { background: white; border-radius: 35px; margin: 0 18px 30px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.07); position: relative; animation: up 0.6s ease-out; }
        @keyframes up { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .card-body { padding: 25px; }

        /* ìˆ˜ì •/ì‚­ì œ ë©”ë‰´ */
        .edit-menu { position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; gap: 5px; }
        .edit-btn { background: rgba(255,255,255,0.9); border: none; padding: 6px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; cursor: pointer; color: #64748b; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ìˆ˜ì • ëª¨ë‹¬ */
        #editModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; backdrop-filter: blur(10px); }
        .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: white; padding: 30px; border-radius: 30px; }

        .swiper-slide img { width: 100%; display: block; object-fit: cover; aspect-ratio: 1/1; }
        .float-cal { position: fixed; bottom: 35px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--main-gradient); color: white; border: none; font-size: 24px; box-shadow: 0 15px 35px rgba(155, 93, 229, 0.4); cursor: pointer; z-index: 2000; }
    </style>
</head>
<body>

<div class="header">
    <div class="category-bar" id="categoryBar">
        <button class="tag-btn active" data-color="var(--main-gradient)" onclick="changeTheme('all', this)">#ì „ì²´</button>
    </div>
</div>

<div class="box">
    <select id="username" style="width:100%; padding:15px; border-radius:18px; border:1px solid #eee; margin-bottom:12px; font-weight:700;">
        <option value="">ëˆ„êµ¬ì‹ ê°€ìš”?</option>
    </select>
    <textarea id="content" rows="3" placeholder="ì˜¤ëŠ˜ ìš°ë¦¬ì˜ ì†Œì¤‘í•œ ì¡°ê°ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
    <input type="file" id="photo" multiple style="display:none" onchange="updateFileCount(this)">
    <label for="photo" id="fileLab" style="display:block; text-align:center; padding:18px; background:#f1f5f9; border-radius:18px; font-size:13px; font-weight:800; margin-bottom:15px; cursor:pointer;">ğŸ“¸ ì‚¬ì§„ ì„ íƒí•˜ê¸° (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
    <div style="display:flex; gap:10px;">
        <button onclick="uploadPost()" id="uploadBtn" style="flex:2; background:var(--main-gradient); color:white; border:none; padding:15px; border-radius:15px; font-weight:900; cursor:pointer;">ì €ì¥í•˜ê¸°</button>
        <button onclick="showFortune()" style="flex:1; background:var(--luck-gradient); color:white; border:none; padding:15px; border-radius:15px; font-weight:900; cursor:pointer;">ìš´ì„¸ ğŸ€</button>
    </div>
</div>

<div id="viewArea"></div>
<div class="feed" id="feed"></div>
<button class="float-cal" onclick="toggleCalendar()">ğŸ“…</button>

<div id="editModal">
    <div class="modal-content">
        <h3 style="margin-top:0; background:var(--main-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">ğŸ“ ê²Œì‹œë¬¼ ìˆ˜ì •</h3>
        <textarea id="editContent" rows="5"></textarea>
        <div style="display:flex; gap:10px;">
            <button onclick="submitEdit()" id="updateBtn" style="flex:2; background:var(--main-gradient); color:white; border:none; padding:15px; border-radius:15px; font-weight:900;">ìˆ˜ì • ì™„ë£Œ</button>
            <button onclick="closeEdit()" style="flex:1; background:#eee; border:none; border-radius:15px; font-weight:900;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
const SB_URL = "YOUR_SUPABASE_URL";
const SB_KEY = "YOUR_SUPABASE_KEY";
const client = supabase.createClient(SB_URL, SB_KEY);

const SQUAD = { 
    "íƒœì§€ì•„": "linear-gradient(90deg, #ff4d6d 0%, #ff80ab 100%)", 
    "ì¡°ì„±ìš°": "linear-gradient(90deg, #007bff 0%, #4facfe 100%)", 
    "ì—¼íƒœì„±": "linear-gradient(90deg, #20c997 0%, #87fcef 100%)", 
    "ê¹€íƒœí˜„": "linear-gradient(90deg, #9b5de5 0%, #cdb4db 100%)", 
    "ì´ì¤€ì„œ": "linear-gradient(90deg, #f15bb5 0%, #f7c5cc 100%)", 
    "ì´ì§€í˜¸": "linear-gradient(90deg, #d4a373 0%, #ffb347 100%)", 
    "ì´ë‹¤ì›": "linear-gradient(90deg, #7b2cbf 0%, #e0c3fc 100%)" 
};
let globalPosts = [], calendarMode = false, currentTag = "all", currentEditId = null, calendarDate = new Date();

window.onload = () => {
    const bar = document.getElementById("categoryBar");
    const sel = document.getElementById("username");
    Object.keys(SQUAD).forEach(name => {
        const btn = document.createElement("button");
        btn.className="tag-btn"; btn.innerText="#"+name; btn.setAttribute("data-color", SQUAD[name]);
        btn.onclick = e => changeTheme(name, e.target);
        bar.appendChild(btn);
        sel.innerHTML += `<option value="${name}">${name}</option>`;
    });
    loadFeed();
};

async function loadFeed() {
    const { data } = await client.from("posts").select("*").order("created_at", {ascending:false});
    globalPosts = data || [];
    renderMain();
}

function renderMain() {
    const view = document.getElementById("viewArea"); const feed = document.getElementById("feed");
    view.innerHTML = ""; feed.innerHTML = "";
    if(calendarMode) { renderCalendar(); return; }
    const list = currentTag === "all" ? globalPosts : globalPosts.filter(p => p.user_name === currentTag);
    list.forEach(p => renderCard(p, feed));
    new Swiper('.swiper', { pagination: { el: '.swiper-pagination' } });
}

function renderCard(p, container) {
    const grad = SQUAD[p.user_name] || "var(--main-gradient)";
    const me = document.getElementById("username").value;
    const isMine = p.user_name === me;
    
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
        <div style="height:10px; background:${grad}"></div>
        ${isMine ? `<div class="edit-menu">
            <button class="edit-btn" onclick="openEdit('${p.id}', \`${p.content}\`)">ìˆ˜ì •</button>
            <button class="edit-btn" style="color:#ff4d6d" onclick="deletePost('${p.id}')">ì‚­ì œ</button>
        </div>` : ""}
        ${p.image_urls?.length ? `<div class="swiper"><div class="swiper-wrapper">${p.image_urls.map(url => `<div class="swiper-slide"><img src="${url}"></div>`).join('')}</div><div class="swiper-pagination"></div></div>` : ""}
        <div class="card-body">
            <div style="white-space:pre-wrap; line-height:1.7; font-size:16px; margin-bottom:15px;">${p.content}</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="background:${grad}; -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:14px;">BY ${p.user_name}</b>
                <span onclick="toggleLike('${p.id}')" style="cursor:pointer; font-weight:900; color:${p.liked_users?.includes(me)?'#ff4d6d':'#cbd5e1'}">â¤ ${p.likes||0}</span>
            </div>
            ${p.liked_users?.length ? `<div style="font-size:11px; color:#94a3b8; margin-top:5px;">${p.liked_users.join(', ')}ë‹˜ì´ ì¢‹ì•„í•©ë‹ˆë‹¤.</div>` : ""}
            <div id="cbox-${p.id}" style="margin-top:15px; border-top:1px solid #f1f5f9; padding-top:10px;"></div>
            <input style="width:100%; border:none; background:#f8fafc; padding:12px; border-radius:12px; font-size:13px; margin-top:10px; box-sizing:border-box;" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." onkeydown="if(event.key==='Enter') addComm('${p.id}', this)">
        </div>`;
    container.appendChild(card);
    loadComm(p.id);
}

async function uploadPost() {
    const user = document.getElementById("username").value;
    const content = document.getElementById("content").value;
    const files = document.getElementById("photo").files;
    if(!user || !content) return alert("ì´ë¦„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜!");
    
    const btn = document.getElementById("uploadBtn");
    btn.innerText = "ì—…ë¡œë“œ ì¤‘..."; btn.disabled = true;

    let urls = [];
    for(let f of files) {
        const path = `archive/${Date.now()}_${f.name}`;
        await client.storage.from("photos").upload(path, f);
        urls.push(client.storage.from("photos").getPublicUrl(path).data.publicUrl);
    }
    await client.from("posts").insert({ user_name:user, content:content, image_urls:urls });
    location.reload();
}

function openEdit(id, content) { currentEditId = id; document.getElementById("editContent").value = content; document.getElementById("editModal").style.display = "block"; }
function closeEdit() { document.getElementById("editModal").style.display = "none"; }
async function submitEdit() {
    const btn = document.getElementById("updateBtn"); btn.innerText = "ìˆ˜ì • ì¤‘...";
    await client.from("posts").update({ content: document.getElementById("editContent").value }).eq("id", currentEditId);
    location.reload();
}
async function deletePost(id) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { await client.from("posts").delete().eq("id", id); location.reload(); } }

async function toggleLike(id) {
    const me = document.getElementById("username").value; if(!me) return alert("ëˆ„êµ¬ì‹ ê°€ìš”?");
    const { data } = await client.from("posts").select("*").eq("id", id).single();
    let likes = data.likes, users = data.liked_users || [];
    if(users.includes(me)) { users = users.filter(u => u !== me); likes--; }
    else { users.push(me); likes++; }
    await client.from("posts").update({ likes, liked_users: users }).eq("id", id);
    loadFeed();
}

async function addComm(pid, el) {
    const user = document.getElementById("username").value; if(!user || !el.value) return;
    await client.from("comments").insert({ post_id:pid, user_name:user, content:el.value });
    el.value = ""; loadComm(pid);
}

async function loadComm(pid) {
    const { data } = await client.from("comments").select("*").eq("post_id", pid).order("created_at", {ascending:true});
    document.getElementById("cbox-"+pid).innerHTML = (data||[]).map(c => `<div style="font-size:13px; margin-bottom:5px;"><b>${c.user_name}</b> ${c.content}</div>`).join("");
}

function changeTheme(tag, btn) {
    currentTag = tag;
    document.querySelectorAll(".tag-btn").forEach(b => { b.classList.remove("active"); b.style.background="#fff"; b.style.color="#78716c"; });
    btn.classList.add("active"); btn.style.background = btn.getAttribute("data-color"); btn.style.color="#fff";
    renderMain();
}

function updateFileCount(el) { document.getElementById("fileLab").innerText = `âœ… ${el.files.length}ì¥ ì„ íƒë¨`; }
function toggleCalendar() { calendarMode = !calendarMode; renderMain(); }
function renderCalendar() {
    const view = document.getElementById("viewArea"); const [y, m] = [calendarDate.getFullYear(), calendarDate.getMonth()];
    const first = new Date(y, m, 1).getDay(); const last = new Date(y, m+1, 0).getDate();
    let h = `<div style="display:flex; justify-content:space-between; align-items:center; padding:20px 30px;"><button class="tag-btn" onclick="chM(-1)">â—€</button><b>${y}.${m+1}</b><button class="tag-btn" onclick="chM(1)">â–¶</button></div><div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; padding:0 20px 40px;">`;
    for(let i=0; i<first; i++) h += `<div></div>`;
    for(let d=1; d<=last; d++) {
        const has = globalPosts.some(p => { const dt = new Date(p.created_at); return dt.getDate() === d && dt.getMonth() === m && dt.getFullYear() === y; });
        h += `<div onclick="filterD(${y},${m},${d})" style="height:50px; display:flex; justify-content:center; align-items:center; font-size:14px; font-weight:800; border-radius:15px; cursor:pointer; ${has?'background:#fff1f2; color:#ff4d6d; border:1px solid #ff4d6d;':'background:white; border:1px solid #eee;'}">${d}</div>`;
    }
    view.innerHTML = h + `</div>`;
}
function chM(v) { calendarDate.setMonth(calendarDate.getMonth() + v); renderCalendar(); }
function filterD(y, m, d) { calendarMode = false; document.getElementById("viewArea").innerHTML = `<div style="padding:20px 25px; font-weight:900; font-size:18px; color:#ff4d6d">ğŸ“ ${y}.${m+1}.${d}ì˜ ê¸°ë¡</div>`; const filtered = globalPosts.filter(p => { const dt = new Date(p.created_at); return dt.getDate() === d && dt.getMonth() === m && dt.getFullYear() === y; }); const feed = document.getElementById("feed"); feed.innerHTML = ""; filtered.forEach(p => renderCard(p, feed)); new Swiper('.swiper', { pagination: { el: '.swiper-pagination' } }); }
function showFortune() {
    const user = document.getElementById("username").value; if(!user) return alert("ëˆ„êµ¬ì‹ ê°€ìš”?");
    const list = ["ğŸ“¸ ì˜¤ëŠ˜ ì‚¬ì§„ ì°ìœ¼ë©´ ë¬´ì¡°ê±´ ë ˆì „ë“œ!", "ğŸ’˜ ì˜¤ëŠ˜ì€ ì†”ì§í•´ì ¸ë„ ì¢‹ì€ ë‚ !", "ğŸ¤« ë¹„ë°€ì„ ì§€í‚¤ë©´ í° ë³µì´ ì˜µë‹ˆë‹¤.", "ğŸ”¥ ë„¤ ê¸€ì´ ì˜¤ëŠ˜ ìµœê³ ì˜ ì¸ê¸°ê¸€!", "âœ¨ ìƒê°ì§€ë„ ëª»í•œ í–‰ìš´ì´ ì°¾ì•„ì˜µë‹ˆë‹¤."];
    const seed = user + new Date().toDateString();
    let hash = 0; for(let i=0; i<seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i);
    alert(`ğŸ€ ${user}ë‹˜ì˜ ìš´ì„¸: ${list[Math.abs(hash)%list.length]}`);
}
</script>
</body>
</html>
