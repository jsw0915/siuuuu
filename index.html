<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIUUUU! ULTIMATE ARCHIVE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --main: #eab308; --bg: #fdfbf7; --text: #44403c; --grad: linear-gradient(135deg, #ff4d6d 0%, #9b5de5 100%); }
        body { background: var(--bg); color: var(--text); margin: 0; font-family: 'Pretendard', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Ìó§Îçî & Ïπ¥ÌÖåÍ≥†Î¶¨ */
        .header { position: sticky; top: 0; z-index: 2000; background: rgba(253, 251, 247, 0.8); backdrop-filter: blur(15px); padding: 15px 0; }
        .scroll-container { display: flex; overflow-x: auto; gap: 12px; padding: 5px 20px; scrollbar-width: none; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .tag-btn { flex: 0 0 auto; padding: 10px 24px; border-radius: 50px; background: white; border: 2px solid rgba(0,0,0,0.05); font-weight: 800; font-size: 13px; cursor: pointer; transition: 0.3s; color: #78716c; }
        .tag-btn.active { background: var(--main); color: white; transform: scale(1.05); border-color: transparent; box-shadow: 0 5px 15px rgba(234, 179, 8, 0.3); }

        /* Ïπ¥Îìú UI */
        .post-card { background: white; border-radius: 35px; margin: 0 15px 30px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.04); position: relative; animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .swiper { width: 100%; height: auto; background: #f1f5f9; }
        .swiper-slide img { width: 100%; display: block; aspect-ratio: 1/1; object-fit: cover; }
        
        /* Ï∫òÎ¶∞Îçî */
        .cal-day { height: 85px; vertical-align: top; padding: 8px; border: 0.5px solid rgba(0,0,0,0.02); cursor: pointer; background: white; }
        .day-label { font-size: 9px; padding: 4px; border-radius: 6px; color: white; display: block; margin-top: 3px; font-weight: bold; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .d-day-badge { background: #000; color: #fff; padding: 2px 5px; border-radius: 5px; font-size: 9px; font-weight: 900; margin-left: 5px; }

        /* ÏûÖÎ†•Ï∞Ω & Î™®Îã¨ */
        .input-box { background: white; padding: 25px; border-radius: 35px; margin: 20px 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); }
        textarea { width: 100%; border: none; background: #f8fafc; border-radius: 20px; padding: 18px; font-size: 15px; outline: none; resize: none; box-sizing: border-box; }
        #editModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; backdrop-filter: blur(10px); align-items: center; justify-content: center; }
        .modal-content { width: 85%; max-width: 400px; background: white; padding: 30px; border-radius: 35px; }
    </style>
</head>
<body>

<div id="gate" style="display: flex; position: fixed; inset: 0; z-index: 9999; background: #fdfbf7; flex-direction: column; align-items: center; justify-content: center;">
    <h1 style="font-size: 5rem; font-weight: 900; color: #eab308; font-style: italic; margin: 0;">SIUUUU!</h1>
    <div style="width: 280px; margin-top: 30px;">
        <input id="userName" type="text" placeholder="Ïä§ÏøºÎìú Î©§Î≤Ñ Ïù¥Î¶Ñ" style="width: 100%; padding: 18px; border-radius: 20px; border: 2px solid #eee; text-align: center; font-size: 16px; outline: none; margin-bottom: 12px; box-sizing: border-box;">
        <button onclick="handleLogin()" style="width: 100%; background: #eab308; color: white; padding: 18px; border-radius: 20px; font-weight: 900; border: none; cursor: pointer; font-size: 16px;">SQUAD IN</button>
    </div>
</div>

<div id="app" style="display: none; max-width: 600px; margin: 0 auto; padding-bottom: 50px;">
    <header style="padding: 30px 25px 10px; display: flex; justify-content: space-between; align-items: center;">
        <h1 id="mainTitle" style="font-size: 2.2rem; font-weight: 900; font-style: italic; margin: 0; color: #eab308;">SIUUUU! üî•</h1>
        <button onclick="handleLogout()" style="opacity: 0.3; border: 1px solid #ccc; padding: 6px 12px; border-radius: 10px; background: none; font-size: 11px; font-weight: bold;">EXIT</button>
    </header>

    <div class="post-card" style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="calMonth" style="margin: 0; font-weight: 900; font-size: 1.3rem;"></h2>
            <div style="display: flex; gap: 15px; color: #eab308; font-weight: 900; cursor: pointer;">
                <span onclick="moveMonth(-1)">‚óÄ</span> <span onclick="moveMonth(1)">‚ñ∂</span>
            </div>
        </div>
        <table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 10px;">
            <thead style="color: #94a3b8;"><tr><th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr></thead>
            <tbody id="calBody"></tbody>
        </table>
        <div id="dateEditor" style="display:none; margin-top: 15px; padding: 15px; background: #fdfbf7; border-radius: 20px; border: 1px solid #eee;">
            <p id="selectedDateText" style="font-size: 13px; font-weight: 900; color: #eab308; margin: 0 0 10px;"></p>
            <div id="existingEvents"></div>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <input id="dateInput" type="text" placeholder="ÏÉà ÏùºÏ†ï ÏûÖÎ†•" style="flex:1; padding: 10px; border: 1px solid #eee; border-radius: 10px; font-size: 13px; outline: none;">
                <button onclick="saveDateEvent()" style="background: #eab308; color:white; border:none; padding: 0 15px; border-radius: 10px; font-weight: 900;">Ï∂îÍ∞Ä</button>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="scroll-container" id="categoryBar">
            <button class="tag-btn active" data-color="#eab308" onclick="changeTheme('all', this)">#Ï†ÑÏ≤¥</button>
        </div>
    </div>

    <div class="input-box">
        <textarea id="pContent" rows="3" placeholder="Ïò§Îäò Ïö∞Î¶¨Ïùò ÏÜåÏ§ëÌïú Ï°∞Í∞ÅÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî..."></textarea>
        <div style="display: flex; gap: 10px; margin-top: 12px;">
            <input type="file" id="pFile" style="display: none;" multiple onchange="updateFileStatus(this)">
            <label for="pFile" id="fLab" style="flex: 1; text-align: center; padding: 15px; background: #f8fafc; border-radius: 15px; font-size: 12px; font-weight: 800; border: 2px dashed #eee; color: #94a3b8; cursor: pointer;">üì∏ ÏÇ¨ÏßÑ Ï∂îÍ∞Ä</label>
            <button onclick="savePost()" id="sBtn" style="flex: 1; background: #eab308; color: white; border-radius: 15px; font-weight: 900; border: none; cursor: pointer;">Ï†ÄÏû•ÌïòÍ∏∞</button>
        </div>
    </div>

    <div id="feed"></div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3 style="margin: 0 0 15px; font-weight: 900;">üìù Í≤åÏãúÎ¨º ÏàòÏ†ï</h3>
        <textarea id="editContent" rows="5"></textarea>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="submitEdit()" id="updateBtn" style="flex: 2; background: var(--main); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 900; cursor: pointer;">ÏàòÏ†ï ÏôÑÎ£å</button>
            <button onclick="closeEdit()" style="flex: 1; background: #eee; border: none; border-radius: 15px; font-weight: 900; cursor: pointer;">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>

<script>
    const SQUAD_COLORS = { 'ÌÉúÏßÄÏïÑ': '#ff4d6d', 'Ï°∞ÏÑ±Ïö∞': '#007bff', 'ÏóºÌÉúÏÑ±': '#20c997', 'ÍπÄÌÉúÌòÑ': '#9b5de5', 'Ïù¥Ï§ÄÏÑú': '#f15bb5', 'Ïù¥ÏßÄÌò∏': '#d4a373', 'Ïù¥Îã§Ïõê': '#7b2cbf', 'Ï∂îÏñµ': '#38bdf8', 'ÏÉùÏùº': '#fb7185' };
    const SB_URL = 'https://chlqufwjiwfiqzvmocof.supabase.co';
    const SB_KEY = 'sb_publishable_MyGDUC1VPEyrWP6THcgWEA_mk8HUpQj'; 
    let client, viewDate = new Date(), selDate = "", currentEditId = null;

    window.onload = () => {
        client = supabase.createClient(SB_URL, SB_KEY);
        const bar = document.getElementById("categoryBar");
        Object.keys(SQUAD_COLORS).forEach(name => {
            if(name === 'Ï∂îÏñµ' || name === 'ÏÉùÏùº') return;
            const btn = document.createElement("button");
            btn.className = "tag-btn"; btn.innerText = "#" + name; btn.setAttribute("data-color", SQUAD_COLORS[name]);
            btn.onclick = e => changeTheme(name, e.target);
            bar.appendChild(btn);
        });
        if (localStorage.getItem('siu_user')) showApp();
    };

    function handleLogin() {
        const n = document.getElementById('userName').value.trim();
        if (SQUAD_COLORS[n]) { localStorage.setItem('siu_user', n); showApp(); }
        else { alert("Ï†ïÌôïÌïú Î©§Î≤Ñ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!"); }
    }
    function showApp() { document.getElementById('gate').style.display = 'none'; document.getElementById('app').style.display = 'block'; renderCalendar(); loadFeed(); }
    function handleLogout() { localStorage.removeItem('siu_user'); location.reload(); }

    // D-Day ÏóîÏßÑ
    function getDDay(target) {
        const t = new Date(target); t.setHours(0,0,0,0);
        const today = new Date(); today.setHours(0,0,0,0);
        const diff = Math.ceil((t - today) / (1000 * 60 * 60 * 24));
        return diff === 0 ? "D-Day" : (diff > 0 ? `D-${diff}` : `D+${Math.abs(diff)}`);
    }

    async function loadFeed(filter = 'all') {
        const feed = document.getElementById('feed');
        feed.innerHTML = '<p style="text-align:center; padding:50px; opacity:0.3;">RECALLING MEMORIES...</p>';
        let { data } = await client.from('posts').select('*').order('created_at', { ascending: false });
        if(filter !== 'all') data = data.filter(p => p.user_name === filter);
        
        feed.innerHTML = data.map(p => {
            const isMine = p.user_name === localStorage.getItem('siu_user');
            const urls = p.image_url ? p.image_url.split(',') : [];
            const swiperHtml = urls.length > 0 ? `
                <div class="swiper">
                    <div class="swiper-wrapper">${urls.map(u => `<div class="swiper-slide"><img src="${u}"></div>`).join('')}</div>
                    ${urls.length > 1 ? '<div class="swiper-pagination"></div>' : ''}
                </div>` : '';
            
            return `
                <div class="post-card">
                    ${isMine ? `<div style="position:absolute; top:15px; right:15px; z-index:10; display:flex; gap:5px;">
                        <button onclick="openEdit('${p.id}', \`${p.content}\`)" style="background:rgba(255,255,255,0.9); border:none; padding:5px 10px; border-radius:8px; font-size:10px; font-weight:800; cursor:pointer;">ÏàòÏ†ï</button>
                        <button onclick="deletePost('${p.id}')" style="background:rgba(255,255,255,0.9); border:none; padding:5px 10px; border-radius:8px; font-size:10px; font-weight:800; color:#ff4d6d; cursor:pointer;">ÏÇ≠Ï†ú</button>
                    </div>` : ''}
                    ${swiperHtml}
                    <div style="padding:25px;">
                        <p style="margin:0 0 20px; line-height:1.7; font-size:16px; white-space:pre-wrap;">${p.content.replace(/#(\S+)/g, '<span style="color:var(--main); font-weight:900;">#$1</span>')}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #f8f8f8; padding-top:15px;">
                            <b style="color:${SQUAD_COLORS[p.user_name]}; font-size:14px;">BY ${p.user_name}</b>
                            <span onclick="toggleLike('${p.id}')" style="cursor:pointer; font-weight:900; color:${p.liked_users?.includes(localStorage.getItem('siu_user')) ? '#ff4d6d' : '#cbd5e1'}">‚ù§ ${p.likes || 0}</span>
                        </div>
                        <div id="cbox-${p.id}" style="margin-top:15px; font-size:13px;"></div>
                        <input style="width:100%; border:none; background:#f8fafc; padding:10px; border-radius:10px; font-size:12px; margin-top:10px; box-sizing:border-box;" placeholder="ÎåìÍ∏Ä Îã¨Í∏∞..." onkeydown="if(event.key==='Enter') addComm('${p.id}', this)">
                    </div>
                </div>`;
        }).join('');
        
        new Swiper('.swiper', { pagination: { el: '.swiper-pagination' } });
        data.forEach(p => loadComm(p.id));
    }

    async function savePost() {
        const c = document.getElementById('pContent').value; if(!c) return;
        const btn = document.getElementById('sBtn'); btn.innerText = "ÏóÖÎ°úÎìú Ï§ë..."; btn.disabled = true;
        const files = document.getElementById('pFile').files;
        let urls = [];
        for(let f of files) {
            const name = `${Date.now()}_${f.name}`;
            await client.storage.from('photos').upload(name, f);
            urls.push(client.storage.from('photos').getPublicUrl(name).data.publicUrl);
        }
        await client.from('posts').insert([{ content: c, image_url: urls.join(','), user_name: localStorage.getItem('siu_user') }]);
        location.reload();
    }

    // ÏàòÏ†ï Î°úÏßÅ
    function openEdit(id, content) { currentEditId = id; document.getElementById("editContent").value = content; document.getElementById("editModal").style.display = "flex"; }
    function closeEdit() { document.getElementById("editModal").style.display = "none"; }
    async function submitEdit() {
        await client.from('posts').update({ content: document.getElementById("editContent").value }).eq('id', currentEditId);
        location.reload();
    }

    // ÎåìÍ∏Ä & Ï¢ãÏïÑÏöî
    async function toggleLike(id) {
        const me = localStorage.getItem('siu_user');
        const { data } = await client.from('posts').select('*').eq('id', id).single();
        let likes = data.likes || 0, users = data.liked_users || [];
        if(users.includes(me)) { users = users.filter(u => u !== me); likes--; }
        else { users.push(me); likes++; }
        await client.from('posts').update({ likes, liked_users: users }).eq('id', id);
        loadFeed();
    }
    async function addComm(pid, el) {
        await client.from('comments').insert({ post_id:pid, user_name:localStorage.getItem('siu_user'), content:el.value });
        el.value = ""; loadComm(pid);
    }
    async function loadComm(pid) {
        const { data } = await client.from('comments').select('*').eq('post_id', pid).order('created_at', {ascending:true});
        document.getElementById("cbox-"+pid).innerHTML = (data||[]).map(c => `<div><b>${c.user_name}</b> ${c.content}</div>`).join("");
    }

    // Ï∫òÎ¶∞Îçî ÏóîÏßÑ
    function renderCalendar() {
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        document.getElementById('calMonth').innerText = `${y}.${String(m+1).padStart(2,'0')}`;
        const first = new Date(y, m, 1).getDay(), last = new Date(y, m + 1, 0).getDate();
        const body = document.getElementById('calBody'); body.innerHTML = '';
        let date = 1;
        for (let i = 0; i < 6; i++) {
            let row = document.createElement('tr');
            for (let j = 0; j < 7; j++) {
                let cell = document.createElement('td'); cell.className = "cal-day";
                if (i === 0 && j < first || date > last) { cell.innerHTML = ""; }
                else {
                    const dKey = `${y}-${String(m+1).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
                    cell.onclick = () => openDateEditor(dKey);
                    cell.innerHTML = `<span style="font-weight:900; opacity:0.15; font-size:11px;">${date}</span><div id="ev-${dKey}"></div>`;
                    date++;
                }
                row.appendChild(cell);
            }
            body.appendChild(row); if (date > last) break;
        }
        fetchCalData();
    }
    async function fetchCalData() {
        const { data } = await client.from('schedules').select('*');
        data?.forEach(ev => {
            const h = document.getElementById(`ev-${ev.target_date}`);
            if(h) h.innerHTML += `<span class="day-label" style="background:#38bdf8">${ev.title}</span>`;
        });
    }
    function openDateEditor(date) {
        selDate = date; document.getElementById('dateEditor').style.display = 'block';
        document.getElementById('selectedDateText').innerText = `üóìÔ∏è ${date} (${getDDay(date)})`;
        client.from('schedules').select('*').eq('target_date', date).then(({data}) => {
            document.getElementById('existingEvents').innerHTML = data.map(s => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; font-size:13px; border-bottom:1px solid #eee;">
                    <span>${s.title} <span class="d-day-badge">${getDDay(s.target_date)}</span></span>
                    ${s.user_name === localStorage.getItem('siu_user') ? `<button onclick="delSch('${s.id}')" style="color:#ff4d6d; border:none; background:none; font-weight:bold;">ÏÇ≠Ï†ú</button>` : ''}
                </div>`).join('');
        });
    }
    async function saveDateEvent() {
        const title = document.getElementById('dateInput').value;
        await client.from('schedules').insert([{ user_name: localStorage.getItem('siu_user'), title, target_date: selDate }]);
        location.reload();
    }
    async function delSch(id) { await client.from('schedules').delete().eq('id', id); location.reload(); }
    async function deletePost(id) { if(confirm("ÏÇ≠Ï†úÌï†ÍπåÏöî?")) { await client.from('posts').delete().eq('id', id); location.reload(); } }
    function changeTheme(tag, btn) {
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active'); loadFeed(tag);
    }
    function moveMonth(v) { viewDate.setMonth(viewDate.getMonth() + v); renderCalendar(); }
    function updateFileStatus(el) { document.getElementById('fLab').innerText = `üì∏ ${el.files.length}Ïû• ÏÑ†ÌÉùÎê®`; }
</script>
</body>
</html>
