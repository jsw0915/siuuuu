<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>SIUUUU! Infinity Archive</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --bg: #fdfbf7; --main: #eab308; --accent: #ff4d6d; }
        body { margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg); color: #1f2937; -webkit-tap-highlight-color: transparent; }

        /* UI ê³ ë„í™” */
        .header { position: sticky; top: 0; z-index: 1000; background: rgba(253,251,247,0.9); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .category-bar { display: flex; gap: 10px; overflow-x: auto; padding: 15px 20px; scrollbar-width: none; }
        .tag-btn { flex: 0 0 auto; padding: 10px 20px; border-radius: 50px; background: #fff; border: 1.5px solid #eee; font-weight: 800; font-size: 13px; cursor: pointer; transition: 0.3s; }
        .tag-btn.active { color: white !important; transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        .box { max-width: 550px; margin: 20px auto; background: #fff; border-radius: 30px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        textarea { width: 100%; border-radius: 18px; border: 1px solid #f1f5f9; background: #f8fafc; padding: 15px; font-family: inherit; margin-bottom: 12px; outline: none; resize: none; }
        
        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .swiper { width: 100%; height: auto; border-bottom: 1px solid #eee; }
        .swiper-slide img { width: 100%; display: block; object-fit: cover; aspect-ratio: 1/1; }
        .swiper-pagination-bullet-active { background: var(--main) !important; }

        .card { background: #fff; border-radius: 35px; margin: 0 18px 30px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.06); position: relative; }
        .card-body { padding: 25px; }
        .liked-list { font-size: 11px; color: #94a3b8; margin-top: 5px; }

        .float-cal { position: fixed; bottom: 30px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: #111; color: #fff; border: none; font-size: 24px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); cursor: pointer; z-index: 2000; }
    </style>
</head>
<body>

<div class="header">
    <div class="category-bar" id="categoryBar">
        <button class="tag-btn active" data-color="#eab308" onclick="changeTheme('all', this)">#ì „ì²´</button>
    </div>
</div>

<div class="box">
    <select id="username" style="width:100%; padding:12px; border-radius:15px; border:1px solid #eee; margin-bottom:10px; font-weight:700;">
        <option value="">ëˆ„êµ¬ì‹ ê°€ìš”?</option>
    </select>
    <textarea id="content" rows="3" placeholder="ì˜¤ëŠ˜ ìš°ë¦¬ì˜ ì¡°ê°ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
    <input type="file" id="photo" multiple style="display:none" onchange="updateFileCount(this)">
    <label for="photo" id="fileLab" style="display:block; text-align:center; padding:15px; background:#f1f5f9; border-radius:15px; font-size:13px; font-weight:800; margin-bottom:12px; cursor:pointer; color:#475569;">ğŸ“¸ ì‚¬ì§„ ì„ íƒí•˜ê¸° (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
    <div style="display:flex; gap:10px;">
        <button class="btn" id="uploadBtn" onclick="uploadPost()" style="flex:2; background:var(--main); color:white; border:none; padding:15px; border-radius:15px; font-weight:900; cursor:pointer;">ì €ì¥í•˜ê¸°</button>
        <button class="btn" onclick="showFortune()" style="flex:1; background:#10b981; color:white; border:none; padding:15px; border-radius:15px; font-weight:900; cursor:pointer;">ìš´ì„¸ ğŸ€</button>
    </div>
</div>

<div id="viewArea"></div>
<div class="feed" id="feed"></div>
<button class="float-cal" onclick="toggleCalendar()">ğŸ“…</button>

<script>
// [í™˜ê²½ ì„¤ì •]
const SB_URL = "YOUR_SUPABASE_URL";
const SB_KEY = "YOUR_SUPABASE_KEY";
const client = supabase.createClient(SB_URL, SB_KEY);

const SQUAD = { "íƒœì§€ì•„": "#ff4d6d", "ì¡°ì„±ìš°": "#007bff", "ì—¼íƒœì„±": "#20c997", "ê¹€íƒœí˜„": "#9b5de5", "ì´ì¤€ì„œ": "#f15bb5", "ì´ì§€í˜¸": "#d4a373", "ì´ë‹¤ì›": "#7b2cbf" };
let globalPosts = [], calendarMode = false, currentTag = "all", calendarDate = new Date();

window.onload = () => {
    initUI();
    loadFeed();
};

function initUI() {
    const bar = document.getElementById("categoryBar");
    const sel = document.getElementById("username");
    Object.keys(SQUAD).forEach(name => {
        const btn = document.createElement("button");
        btn.className="tag-btn"; btn.innerText="#"+name; btn.setAttribute("data-color", SQUAD[name]);
        btn.onclick = e => changeTheme(name, e.target);
        bar.appendChild(btn);
        sel.innerHTML += `<option value="${name}">${name}</option>`;
    });
}

async function loadFeed() {
    const { data } = await client.from("posts").select("*").order("created_at", {ascending:false});
    globalPosts = data || [];
    renderMain();
}

function renderMain() {
    const view = document.getElementById("viewArea");
    const feed = document.getElementById("feed");
    view.innerHTML = ""; feed.innerHTML = "";
    if(calendarMode) { renderCalendar(); return; }
    const list = currentTag === "all" ? globalPosts : globalPosts.filter(p => p.user_name === currentTag);
    list.forEach(p => renderCard(p, feed));
    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” (ë Œë”ë§ í›„ ì‹¤í–‰)
    new Swiper('.swiper', { pagination: { el: '.swiper-pagination' }, loop: false });
}

function renderCard(p, container) {
    const color = SQUAD[p.user_name] || "#eee";
    const me = document.getElementById("username").value;
    const isLiked = p.liked_users?.includes(me);
    
    // ìŠ¬ë¼ì´ë” êµ¬ì¡° ìƒì„±
    let imgSection = "";
    if(p.image_urls && p.image_urls.length > 0) {
        imgSection = `
            <div class="swiper">
                <div class="swiper-wrapper">
                    ${p.image_urls.map(url => `<div class="swiper-slide"><img src="${url}" loading="lazy"></div>`).join('')}
                </div>
                <div class="swiper-pagination"></div>
            </div>`;
    }

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
        <div style="height:8px; background:${color}"></div>
        ${imgSection}
        <div class="card-body">
            <div style="white-space:pre-wrap; line-height:1.7; font-size:15px; margin-bottom:15px; font-weight:500;">${p.content}</div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="color:${color}; font-size:14px;">BY ${p.user_name}</b>
                <span onclick="toggleLike('${p.id}')" style="cursor:pointer; font-weight:900; color:${isLiked?SQUAD['íƒœì§€ì•„']:'#cbd5e1'}; font-size:16px;">â¤ ${p.likes||0}</span>
            </div>
            ${p.liked_users?.length ? `<div class="liked-list">${p.liked_users.join(', ')}ë‹˜ì´ ì¢‹ì•„í•©ë‹ˆë‹¤.</div>` : ''}
            <div class="comm-wrap" id="cbox-${p.id}"></div>
            <input style="width:100%; border:none; background:#f1f5f9; padding:12px; border-radius:12px; font-size:13px; margin-top:15px; box-sizing:border-box; outline:none;" 
                   placeholder="ëŒ“ê¸€ë¡œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”..." onkeydown="if(event.key==='Enter') addComm('${p.id}', this)">
        </div>`;
    container.appendChild(card);
    loadComm(p.id);
}

// ì—…ë¡œë“œ, ì¢‹ì•„ìš”, ëŒ“ê¸€, ìº˜ë¦°ë” ë¡œì§ (ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ë˜ ì‹œë®¬ë ˆì´ì…˜ ê¸°ë°˜ ì˜ˆì™¸ì²˜ë¦¬ ê°•í™”)
async function uploadPost() {
    const user = document.getElementById("username").value;
    const content = document.getElementById("content").value;
    const files = document.getElementById("photo").files;
    const btn = document.getElementById("uploadBtn");
    if(!user || !content) return alert("ë©¤ë²„ì™€ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");

    btn.innerText = "ë°ì´í„° ì „ì†¡ ì¤‘...";
    btn.disabled = true;

    let urls = [];
    try {
        for(let file of files) {
            const path = `archive/${Date.now()}_${file.name}`;
            await client.storage.from("photos").upload(path, file);
            urls.push(client.storage.from("photos").getPublicUrl(path).data.publicUrl);
        }
        await client.from("posts").insert({ user_name: user, content: content, image_urls: urls, likes: 0, liked_users: [] });
        location.reload();
    } catch (e) {
        alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        btn.disabled = false;
        btn.innerText = "ì €ì¥í•˜ê¸°";
    }
}

function updateFileCount(el) {
    document.getElementById('fileLab').innerText = el.files.length > 0 ? `âœ… ${el.files.length}ì¥ì˜ ì‚¬ì§„ ì¤€ë¹„ë¨` : "ğŸ“¸ ì‚¬ì§„ ì„ íƒí•˜ê¸° (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)";
}

async function toggleLike(id) {
    const me = document.getElementById("username").value;
    if(!me) return alert("ëˆ„êµ¬ì‹ ì§€ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ˜Š");
    const { data } = await client.from("posts").select("likes,liked_users").eq("id", id).single();
    let { likes, liked_users } = data;
    liked_users = liked_users || [];
    if(liked_users.includes(me)) { liked_users = liked_users.filter(u => u !== me); likes--; }
    else { liked_users.push(me); likes++; }
    await client.from("posts").update({ likes, liked_users }).eq("id", id);
    loadFeed();
}

async function addComm(pid, el) {
    const user = document.getElementById("username").value;
    if(!user || !el.value.trim()) return;
    await client.from("comments").insert({ post_id:pid, user_name:user, content:el.value });
    el.value = ""; loadComm(pid);
}

async function loadComm(pid) {
    const { data } = await client.from("comments").select("*").eq("post_id", pid).order("created_at", {ascending:true});
    const box = document.getElementById("cbox-"+pid);
    const me = document.getElementById("username").value;
    box.innerHTML = (data||[]).map(c => `
        <div style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:13px;"><b style="color:${SQUAD[c.user_name]}">${c.user_name}</b> ${c.content}</span>
            ${c.user_name === me ? `<span style="color:#cbd5e1; font-size:10px; cursor:pointer;" onclick="delComm('${c.id}','${pid}')">ì‚­ì œ</span>` : ""}
        </div>`).join("");
}

async function delComm(id, pid) { if(confirm("ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?")) { await client.from("comments").delete().eq("id", id); loadComm(pid); } }

function toggleCalendar() { calendarMode = !calendarMode; renderMain(); }
function renderCalendar() {
    const view = document.getElementById("viewArea");
    const [y, m] = [calendarDate.getFullYear(), calendarDate.getMonth()];
    const first = new Date(y, m, 1).getDay();
    const last = new Date(y, m+1, 0).getDate();
    let h = `<div style="display:flex; justify-content:space-between; align-items:center; padding:20px 30px;">
                <button class="tag-btn" onclick="chM(-1)">â—€</button><b style="font-size:18px;">${y}.${m+1}</b><button class="tag-btn" onclick="chM(1)">â–¶</button>
             </div><div style="display:grid; grid-template-columns:repeat(7, 1fr); gap:8px; padding:0 20px 30px;">`;
    for(let i=0; i<first; i++) h += `<div></div>`;
    for(let d=1; d<=last; d++) {
        const has = globalPosts.some(p => { const dt = new Date(p.created_at); return dt.getDate() === d && dt.getMonth() === m && dt.getFullYear() === y; });
        h += `<div onclick="filterD(${y},${m},${d})" style="height:50px; display:flex; flex-direction:column; justify-content:center; align-items:center; font-size:14px; font-weight:800; border-radius:15px; cursor:pointer; ${has?'background:#fff1f2; color:var(--accent); border:1.5px solid var(--accent);':'background:#fff; border:1px solid #eee;'}">${d}</div>`;
    }
    view.innerHTML = h + `</div>`;
}
function chM(v) { calendarDate.setMonth(calendarDate.getMonth() + v); renderCalendar(); }
function filterD(y, m, d) { 
    calendarMode = false; 
    document.getElementById("viewArea").innerHTML = `<div style="padding:20px 25px; font-weight:900; font-size:20px; color:var(--main)">ğŸ“ ${y}.${m+1}.${d}ì˜ ì¡°ê°ë“¤</div>`;
    const filtered = globalPosts.filter(p => { const dt = new Date(p.created_at); return dt.getDate() === d && dt.getMonth() === m && dt.getFullYear() === y; });
    const feed = document.getElementById("feed"); feed.innerHTML = "";
    filtered.length ? filtered.forEach(p => renderCard(p, feed)) : feed.innerHTML="<p style='text-align:center; padding:50px; opacity:0.3;'>ì´ë‚ ì€ ê¸°ë¡ëœ ì¶”ì–µì´ ì—†ì–´ìš”.</p>";
    new Swiper('.swiper', { pagination: { el: '.swiper-pagination' } });
}

function changeTheme(tag, btn) {
    currentTag = tag;
    document.querySelectorAll(".tag-btn").forEach(b => { b.classList.remove("active"); b.style.background="#fff"; b.style.color="#78716c"; b.style.borderColor="#eee"; });
    btn.classList.add("active"); btn.style.background = btn.getAttribute("data-color"); btn.style.color="#fff"; btn.style.borderColor="transparent";
    renderMain();
}

function showFortune() {
    const user = document.getElementById("username").value;
    if(!user) return alert("ëˆ„êµ¬ì‹ ê°€ìš”? ë¨¼ì € ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ”®");
    const list = ["ğŸ“¸ ì˜¤ëŠ˜ ì‚¬ì§„ ì°ìœ¼ë©´ ë¬´ì¡°ê±´ ë ˆì „ë“œ!", "ğŸ’˜ ì˜¤ëŠ˜ì€ ì†”ì§í•´ì ¸ë„ ì¢‹ì€ ë‚ ì´ì—ìš”.", "ğŸ¤« ë¹„ë°€ì„ ì§€í‚¤ë©´ í° ë³µì´ ì˜µë‹ˆë‹¤.", "ğŸ”¥ ë„¤ê°€ ì˜¬ë¦° ê¸€ì´ ì˜¤ëŠ˜ ìµœê³ ì˜ ì¸ê¸°ê¸€!", "âœ¨ ìƒê°ì§€ë„ ëª»í•œ í–‰ìš´ì´ ì°¾ì•„ì˜µë‹ˆë‹¤.", "ğŸ’¸ ì§€ê°‘ì„ ì˜ ì±™ê¸°ì„¸ìš”, ì†Œì†Œí•œ ì§€ì¶œ ì£¼ì˜!", "ğŸ£ ì˜¤ëŠ˜ ë§›ìˆëŠ” ê±° ë¨¹ì„ ë³µì´ í„°ì¡Œë„¤ìš”!", "ğŸ ëˆ„êµ°ê°€ ë„ˆë¥¼ ìœ„í•´ ì‘ì€ ì„ ë¬¼ì„ ì¤€ë¹„ ì¤‘!", "ğŸƒ ìš´ë™í•˜ë©´ ì»¨ë””ì…˜ì´ ìˆ˜ì§ ìƒìŠ¹!", "ğŸ˜´ ì˜¤ëŠ˜ì€ ì¼ì° ì˜ìˆ˜ë¡ ë‚´ì¼ í–‰ìš´ì´ ì»¤ì ¸ìš”."];
    const seed = user + new Date().getFullYear() + (new Date().getMonth()+1) + new Date().getDate();
    let hash = 0; for(let i=0; i<seed.length; i++) hash = ((hash << 5) - hash) + seed.charCodeAt(i);
    alert(`ğŸ€ ${user}ë‹˜ì˜ ì˜¤ëŠ˜ ìš´ì„¸\n\n"${list[Math.abs(hash)%list.length]}"\n\n(ë§¤ì¼ ìì •ì— ìƒˆë¡œìš´ ìš´ì„¸ê°€ ì°¾ì•„ì˜µë‹ˆë‹¤!)`);
}
</script>
</body>
</html>
