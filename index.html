<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIUUUU! ARCHIVE ULTIMATE PREMIUM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --main: #eab308; --bg: #fdfbf7; --text: #44403c; --green: #10b981; --pink: #fb7185; --blue: #38bdf8; }
        body { background-color: var(--bg); color: var(--text); margin: 0; font-family: 'Pretendard', sans-serif; transition: 0.5s; overflow-x: hidden; }
        .scroll-container { display: flex; overflow-x: auto; gap: 12px; scrollbar-width: none; padding: 10px 20px; -webkit-overflow-scrolling: touch; cursor: grab; }
        .scroll-container::-webkit-scrollbar { display: none; }
        .post-card { background: white; border-radius: 35px; margin: 0 15px 30px; position: relative; box-shadow: 0 15px 35px rgba(0,0,0,0.04); overflow: hidden; }
        .image-slider { display: flex; overflow-x: auto; snap-type: x mandatory; background: #f1f5f9; scrollbar-width: none; position: relative; }
        .image-slider img { flex: 0 0 100%; width: 100%; max-height: 500px; object-fit: cover; snap-align: start; cursor: pointer; }
        .cal-day { height: 100px; vertical-align: top; padding: 8px; border: 0.5px solid rgba(0,0,0,0.05); cursor: pointer; background: #fff; position: relative; }
        .ev-h { display: flex; flex-direction: column; gap: 3px; margin-top: 5px; overflow-y: auto; max-height: 70px; scrollbar-width: none; }
        .day-label { font-size: 10px; padding: 4px 6px; border-radius: 6px; color: white !important; display: block; font-weight: 800; text-align: center; white-space: nowrap; overflow: hidden; }
        .label-green { background: var(--green) !important; } .label-pink { background: var(--pink) !important; }
        textarea { width: 100%; min-height: 180px; border: none; background: #f8fafc; border-radius: 20px; padding: 25px; font-size: 16px; outline: none; resize: none; box-sizing: border-box; }
        .tag-btn { flex: 0 0 auto; padding: 12px 28px; border-radius: 50px; background: white; border: 2px solid rgba(0,0,0,0.05); font-size: 14px; font-weight: 800; cursor: pointer; }
        .tag-btn.active { color: white !important; transform: scale(1.05); }
        .comment-item { font-size: 13px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .post-menu { position: absolute; top: 20px; right: 20px; z-index: 10; display: flex; gap: 8px; }
        .menu-btn { background: rgba(255,255,255,0.8); border: none; padding: 5px 10px; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .like-badge { position: absolute; bottom: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 5px 12px; border-radius: 20px; font-weight: 900; color: #fb7185; pointer-events: none; }
    </style>
</head>
<body>
<div id="gate" style="display: flex; position: fixed; inset: 0; z-index: 9999; background: #fdfbf7; flex-direction: column; align-items: center; justify-content: center;">
    <h1 style="font-size: 5rem; font-weight: 900; color: #eab308; font-style: italic;">SIUUUU!</h1>
    <div style="width: 300px; margin-top: 30px;">
        <input id="userName" type="text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 20px; border-radius: 20px; border: 2px solid #eee; text-align: center; font-size: 18px; outline: none;">
        <button onclick="handleLogin()" style="width: 100%; background: #eab308; color: white; padding: 20px; border-radius: 20px; font-weight: 900; border: none; margin-top:10px; cursor: pointer;">SQUAD IN</button>
    </div>
</div>
<div id="app" style="display: none; max-width: 600px; margin: 0 auto; padding-bottom: 100px;">
    <header style="padding: 40px 25px 20px; display: flex; justify-content: space-between; align-items: center;">
        <h1 id="mainTitle" style="font-size: 2.5rem; font-weight: 900; font-style: italic; margin:0;">SIUUUU! ğŸ”¥</h1>
        <button onclick="handleLogout()" style="opacity: 0.4; border: 1px solid #ccc; padding: 8px 15px; border-radius: 12px; background: none; cursor: pointer;">EXIT</button>
    </header>
    <div id="feed"></div>
</div>

<script>
    // [ê¸°ì¡´ ìƒìˆ˜ ë° ì´ˆê¸°í™” ë¡œì§ ìœ ì§€]
    const SB_URL = 'https://chlqufwjiwfiqzvmocof.supabase.co', SB_KEY = 'sb_publishable_MyGDUC1VPEyrWP6THcgWEA_mk8HUpQj'; 
    let client, viewDate = new Date(), selDate = "", allSchedules = [];
    const myName = () => localStorage.getItem('siu_user');

    window.onload = function() { 
        client = supabase.createClient(SB_URL, SB_KEY); 
        if (myName()) showApp(); 
        const sc = document.getElementById('categoryScroll');
        if(sc) sc.addEventListener('wheel', (e) => { e.preventDefault(); sc.scrollLeft += e.deltaY; });
    };

    // [ê¸°ì¡´ ë¡œê·¸ì¸/ìº˜ë¦°ë” í•¨ìˆ˜ë“¤ ìœ ì§€]

    async function loadFeed(filter = 'all') {
        const feedDiv = document.getElementById('feed');
        let { data: posts } = await client.from('posts').select('*, comments(*)').order('created_at', { ascending: false });
        posts = posts || [];
        if(filter !== 'all') posts = (['ì¶”ì–µ','ìƒì¼'].includes(filter)) ? posts.filter(p => p.content.includes(filter)) : posts.filter(p => p.user_name === filter);
        
        feedDiv.innerHTML = posts.map(p => {
            const isMine = p.user_name === myName();
            const likedUsers = p.liked_users ? p.liked_users.split(',') : [];
            const isLiked = likedUsers.includes(myName());

            return `
            <div class="post-card" id="post-${p.id}">
                ${isMine ? `
                <div class="post-menu">
                    <button class="menu-btn" onclick="editPost('${p.id}', \`${p.content}\`)">ìˆ˜ì •</button>
                    <button class="menu-btn" style="color:red;" onclick="deletePost('${p.id}')">ì‚­ì œ</button>
                </div>` : ''}
                <div class="image-slider" ondblclick="toggleLike('${p.id}', '${p.liked_users || ''}', ${p.likes || 0})">
                    ${(p.image_url||'').split(',').filter(u=>u).map(u => `<img src="${u}">`).join('')}
                    <div class="like-badge">â¤ï¸ ${p.likes || 0}</div>
                </div>
                <div style="padding:25px;">
                    <b style="color:${SQUAD_COLORS[p.user_name] || '#eab308'}">BY ${p.user_name}</b>
                    <p id="content-${p.id}" style="font-size:16px; margin:10px 0 20px; line-height:1.7;">${p.content}</p>
                    <div id="comments-${p.id}" style="border-top:1px solid #eee; padding-top:15px;">
                        ${(p.comments || []).map(c => `<div class="comment-item"><span><b>${c.user_name}</b> ${c.content}</span>${c.user_name === myName() ? `<small onclick="deleteComment('${c.id}')" style="opacity:0.3; cursor:pointer;">âœ•</small>` : ''}</div>`).join('')}
                    </div>
                    <div style="display:flex; gap:10px; background:#f8fafc; padding:5px 12px; border-radius:12px; margin-top:10px;">
                        <input type="text" placeholder="ëŒ“ê¸€..." id="cIn-${p.id}" onkeydown="if(event.key==='Enter') addComment('${p.id}')" style="flex:1; border:none; outline:none; background:none; font-size:14px;">
                        <button onclick="addComment('${p.id}')" style="border:none; background:none; color:#eab308; font-weight:bold;">UP</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // --- ì‹ ê·œ/ìˆ˜ì • ê¸°ëŠ¥ ë¡œì§ ---

    // 1. ë”ë¸”í´ë¦­ í•˜íŠ¸ í† ê¸€ (ì·¨ì†Œ ê°€ëŠ¥)
    async function toggleLike(pId, likedStr, currentLikes) {
        let userList = likedStr ? likedStr.split(',').filter(u => u) : [];
        let newLikes = currentLikes;
        
        if (userList.includes(myName())) {
            // ì´ë¯¸ ì¢‹ì•„ìš” í•œ ê²½ìš° -> ì·¨ì†Œ
            userList = userList.filter(u => u !== myName());
            newLikes = Math.max(0, currentLikes - 1);
        } else {
            // ì¢‹ì•„ìš” ì•ˆ í•œ ê²½ìš° -> ì¶”ê°€
            userList.push(myName());
            newLikes = currentLikes + 1;
        }

        await client.from('posts').update({ 
            likes: newLikes, 
            liked_users: userList.join(',') 
        }).eq('id', pId);
        
        loadFeed(); // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ìƒíƒœ ë°˜ì˜
    }

    // 2. ê²Œì‹œë¬¼ ì‚­ì œ
    async function deletePost(pId) {
        if (!confirm("ì´ ê¸°ì–µì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí• ê¹Œìš”?")) return;
        await client.from('posts').delete().eq('id', pId);
        loadFeed();
    }

    // 3. ê²Œì‹œë¬¼ ìˆ˜ì •
    async function editPost(pId, oldContent) {
        const newContent = prompt("ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”:", oldContent);
        if (newContent === null || newContent === oldContent) return;
        await client.from('posts').update({ content: newContent }).eq('id', pId);
        loadFeed();
    }

    // [ê¸°ì¡´ savePost, runLucky ë“± ë‚˜ë¨¸ì§€ í•¨ìˆ˜ ìœ ì§€]
</script>
</body>
</html>
